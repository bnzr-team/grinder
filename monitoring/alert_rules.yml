# GRINDER Alert Rules v5
# Based on metrics from src/grinder/observability/metrics_builder.py
#
# Available metrics:
#   - grinder_up (gauge): 1 if running
#   - grinder_uptime_seconds (gauge): uptime in seconds
#   - grinder_gating_allowed_total{gate} (counter): allowed decisions by gate
#   - grinder_gating_blocked_total{gate,reason} (counter): blocked decisions by gate and reason
#   - grinder_kill_switch_triggered (gauge): 1 if kill-switch active
#   - grinder_kill_switch_trips_total{reason} (counter): total trips by reason
#   - grinder_drawdown_pct (gauge): current drawdown percentage
#   - grinder_high_water_mark (gauge): current equity HWM
#
# ML inference metrics (M8-02c-2, M8-02d):
#   - grinder_ml_active_on (gauge): 1 if ACTIVE mode enabled, 0 otherwise
#   - grinder_ml_block_total{reason} (counter): ACTIVE mode blocks by reason
#   - grinder_ml_inference_total (counter): successful inferences
#   - grinder_ml_inference_errors_total (counter): inference errors
#   - grinder_ml_inference_latency_ms{mode} (histogram): latency by mode (shadow/active)
#
# Reconcile metrics (LC-09b/LC-10/LC-11/LC-15b/LC-18):
#   - grinder_reconcile_runs_total (counter): total loop runs
#   - grinder_reconcile_runs_with_mismatch_total (counter): runs with detected mismatches
#   - grinder_reconcile_mismatch_total{type} (counter): mismatch count by type
#   - grinder_reconcile_last_snapshot_age_seconds (gauge): snapshot freshness
#   - grinder_reconcile_action_planned_total{action} (counter): planned actions
#   - grinder_reconcile_action_executed_total{action} (counter): executed actions (REAL!)
#   - grinder_reconcile_action_blocked_total{reason} (counter): blocked actions by reason
#   - grinder_reconcile_runs_with_remediation_total{action} (counter): runs with remediation
#   - grinder_reconcile_last_remediation_ts_ms (gauge): last remediation timestamp
#   - grinder_reconcile_budget_calls_used_day (gauge): calls used today (LC-18)
#   - grinder_reconcile_budget_calls_remaining_day (gauge): calls remaining today (LC-18)
#   - grinder_reconcile_budget_notional_used_day (gauge): notional USDT used today (LC-18)
#   - grinder_reconcile_budget_notional_remaining_day (gauge): notional USDT remaining (LC-18)
#   - grinder_reconcile_budget_configured (gauge): 1 if budget tracking active (LC-18)
#
# Data quality metrics (Launch-03/Launch-04):
#   - grinder_data_stale_total{stream} (counter): staleness events by stream
#   - grinder_data_gap_total{stream,bucket} (counter): tick gap events by stream and bucket
#   - grinder_data_outlier_total{stream,kind} (counter): outlier events by stream and kind
#   - grinder_reconcile_action_blocked_total{reason="data_quality_*"} (counter): DQ gate blocks
#
# HTTP latency/retry metrics (Launch-05):
#   - grinder_http_requests_total{op,status_class} (counter): HTTP requests by op and status
#   - grinder_http_retries_total{op,reason} (counter): HTTP retry events by op and reason
#   - grinder_http_fail_total{op,reason} (counter): HTTP failures by op and reason
#   - grinder_http_latency_ms{op,le} (histogram): HTTP request latency in milliseconds
#
# Fill health metrics (Launch-06 PR3):
#   - grinder_fill_ingest_polls_total{source} (counter): ingest poll iterations
#   - grinder_fill_ingest_enabled{source} (gauge): 1 if ingest enabled, 0 otherwise
#   - grinder_fill_ingest_errors_total{source,reason} (counter): ingest errors by reason
#   - grinder_fill_cursor_load_total{source,result} (counter): cursor load attempts
#   - grinder_fill_cursor_save_total{source,result} (counter): cursor save attempts
#
# FSM metrics (Launch-13):
#   - grinder_fsm_current_state{state} (gauge): one-hot current FSM state
#   - grinder_fsm_state_duration_seconds (gauge): time in current state
#   - grinder_fsm_transitions_total{from_state,to_state,reason} (counter): state transitions
#   - grinder_fsm_action_blocked_total{state,intent} (counter): actions blocked by FSM
#
# SOR metrics (Launch-14):
#   - grinder_router_decision_total{decision,reason} (counter): router decisions
#   - grinder_router_amend_savings_total (counter): amend savings
#
# AccountSync metrics (Launch-15):
#   - grinder_account_sync_last_ts (gauge): unix ms of last successful sync
#   - grinder_account_sync_age_seconds (gauge): seconds since last sync
#   - grinder_account_sync_errors_total{reason} (counter): sync errors
#   - grinder_account_sync_mismatches_total{rule} (counter): sync mismatches
#
# Consecutive loss guard metrics (PR-C3b):
#   - grinder_risk_consecutive_losses (gauge): current consecutive loss count
#   - grinder_risk_consecutive_loss_trips_total (counter): total guard trips
#
# Port metrics (PR-FUT-1/FUT-2):
#   - grinder_port_order_attempts_total{port,op} (counter): order attempts by port
#   - grinder_port_http_requests_total{port,method,route} (counter): HTTP requests by port

groups:
  - name: grinder_availability
    rules:
      # Critical: GRINDER is completely down
      - alert: GrinderDown
        expr: grinder_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "GRINDER is down"
          description: "GRINDER instance has been unresponsive for more than 1 minute."

      # Critical: Prometheus cannot scrape GRINDER (meta-alert: silences all others)
      - alert: GrinderTargetDown
        expr: up{job="grinder"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Prometheus cannot scrape grinder metrics (all other alerts may be silent)"
          description: |
            Prometheus cannot reach the grinder /metrics endpoint for 1+ minute.
            While this alert is firing, ALL other grinder alerts are effectively blind.
            Check: process alive (pgrep -af grinder), port listening (ss -lntp | grep :9090),
            metrics reachable (curl -sS http://localhost:9090/metrics | head -5),
            docker running (docker ps | grep grinder), firewall/network policy.
          runbook_url: "docs/runbooks/02_HEALTH_TRIAGE.md"

  - name: grinder_gating
    rules:
      # Warning: High rate of blocked gating decisions
      - alert: HighGatingBlocks
        expr: sum(rate(grinder_gating_blocked_total[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High rate of blocked gating decisions"
          description: "More than 0.1 blocks/sec over 5 minutes. Current rate: {{ $value | printf \"%.2f\" }}/sec"

      # Warning: Toxicity-related blocks (spread spike or price impact)
      - alert: ToxicityTriggers
        expr: |
          sum(rate(grinder_gating_blocked_total{reason=~"SPREAD_SPIKE|PRICE_IMPACT_HIGH"}[5m])) > 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Toxicity gate triggered"
          description: "Spread spike or high price impact blocks detected in the last minute."

      # Info: All gating decisions are being blocked
      - alert: AllGatingBlocked
        expr: |
          sum(rate(grinder_gating_allowed_total[5m])) == 0
          and
          sum(rate(grinder_gating_blocked_total[5m])) > 0
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "No gating decisions allowed"
          description: "All gating decisions are being blocked for the past 5 minutes."

  - name: grinder_health
    rules:
      # Info: GRINDER recently restarted
      - alert: GrinderRecentRestart
        expr: grinder_uptime_seconds < 60
        for: 0m
        labels:
          severity: info
        annotations:
          summary: "GRINDER recently restarted"
          description: "GRINDER uptime is {{ $value | printf \"%.0f\" }} seconds."

      # Critical: Trading engine not initialized (process alive but loop didn't start)
      - alert: EngineInitDown
        expr: |
          grinder_live_engine_initialized == 0
          and
          grinder_up == 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Trading engine not initialized for 5+ minutes"
          description: "grinder_live_engine_initialized is 0 while process is up. Engine __init__ may have failed or loop is stuck before init."
          runbook_url: "docs/runbooks/02_HEALTH_TRIAGE.md#engine-initialization-failures"

      # Critical: Futures port made HTTP requests (unexpected in rehearsal/fixture)
      - alert: FuturesHttpRequestsDetected
        expr: |
          increase(grinder_port_http_requests_total{port="futures"}[5m]) > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Futures port made HTTP requests"
          description: "Detected {{ $value | printf \"%.0f\" }} HTTP requests from futures port in last 5m. Open Trading Loop dashboard → Futures HTTP by Route+Method panel to identify which endpoints were called. Any /fapi/ route is a real Binance Futures call. See runbook for triage."
          runbook_url: "docs/runbooks/02_HEALTH_TRIAGE.md#unexpected-futures-http"

      # Warning: Trading loop not ready (HA standby or loop not started)
      - alert: ReadyzNotReady
        expr: |
          grinder_readyz_callback_registered == 1
          and
          grinder_readyz_ready == 0
          and
          grinder_up == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Trading loop not ready for 5+ minutes"
          description: "readyz returning not-ready while process is up. Check HA role (standby/unknown) or whether loop failed to start."
          runbook_url: "docs/runbooks/02_HEALTH_TRIAGE.md#readyz-not-ready"

  - name: grinder_risk
    rules:
      # Critical: Kill-switch has been triggered
      - alert: KillSwitchTripped
        expr: grinder_kill_switch_triggered == 1
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "GRINDER kill-switch is active"
          description: "Kill-switch has been triggered. All trading is halted."

      # Warning: Drawdown approaching threshold
      - alert: HighDrawdown
        expr: grinder_drawdown_pct > 3
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High drawdown detected"
          description: "Current drawdown is {{ $value | printf \"%.2f\" }}%. Kill-switch triggers at 5%."

      # Info: Kill-switch trip count increased
      - alert: KillSwitchTripIncreased
        expr: increase(grinder_kill_switch_trips_total[5m]) > 0
        for: 0m
        labels:
          severity: info
        annotations:
          summary: "Kill-switch trip detected"
          description: "Kill-switch trip count increased in the last 5 minutes."

      # Critical: Consecutive loss guard tripped — PAUSE set (PR-C3b)
      - alert: ConsecutiveLossTrip
        expr: increase(grinder_risk_consecutive_loss_trips_total[5m]) > 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "Consecutive loss guard tripped"
          description: "Consecutive loss guard reached threshold and set PAUSE. Check GRINDER_OPERATOR_OVERRIDE."
          runbook_url: "docs/runbooks/02_HEALTH_TRIAGE.md#consecutive-loss-guard-pr-c3b"

      # Warning: Consecutive losses approaching threshold (early warning at >=3) (PR-C3b)
      - alert: ConsecutiveLossesHigh
        expr: grinder_risk_consecutive_losses >= 3
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Consecutive losses approaching threshold"
          description: "{{ $value }} consecutive losses detected (guard trips at configured threshold, default 5)."
          runbook_url: "docs/runbooks/02_HEALTH_TRIAGE.md#consecutive-loss-guard-pr-c3b"


  - name: grinder_reconcile
    rules:
      # Warning: ReconcileLoop stopped running
      - alert: ReconcileLoopDown
        expr: |
          increase(grinder_reconcile_runs_total[5m]) == 0
          and
          grinder_up == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ReconcileLoop is not running"
          description: "No reconcile loop runs detected in 5 minutes while GRINDER is up."
          runbook_url: "docs/runbooks/16_RECONCILE_ALERTS_SLOS.md#reconcileloopdown"

      # Warning: Snapshot data is stale
      - alert: ReconcileSnapshotStale
        expr: grinder_reconcile_last_snapshot_age_seconds > 120
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Reconcile snapshot is stale"
          description: "Snapshot age is {{ $value | printf \"%.0f\" }} seconds (threshold: 120s). Data may be outdated."
          runbook_url: "docs/runbooks/16_RECONCILE_ALERTS_SLOS.md#reconcilesnapshotstale"

      # Warning: High rate of mismatches detected
      - alert: ReconcileMismatchSpike
        expr: |
          sum(rate(grinder_reconcile_mismatch_total[5m])) > 0.1
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "High rate of reconciliation mismatches"
          description: "Mismatch rate is {{ $value | printf \"%.3f\" }}/sec. Investigate expected vs observed state."
          runbook_url: "docs/runbooks/16_RECONCILE_ALERTS_SLOS.md#reconcilemismatchspike"

      # Critical: Remediation action was EXECUTED (real trade!)
      - alert: ReconcileRemediationExecuted
        expr: increase(grinder_reconcile_action_executed_total[1m]) > 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "Reconcile remediation action EXECUTED"
          description: "A REAL remediation action was executed. Verify it was intended. Action count increased by {{ $value | printf \"%.0f\" }}."
          runbook_url: "docs/runbooks/16_RECONCILE_ALERTS_SLOS.md#reconcileremediationexecuted"

      # Info: Remediation action was planned (dry-run)
      - alert: ReconcileRemediationPlanned
        expr: increase(grinder_reconcile_action_planned_total[5m]) > 0
        for: 0m
        labels:
          severity: info
        annotations:
          summary: "Reconcile remediation action planned"
          description: "A remediation action was planned (dry-run mode). {{ $value | printf \"%.0f\" }} actions planned."
          runbook_url: "docs/runbooks/16_RECONCILE_ALERTS_SLOS.md#reconcileremediationplanned"

      # Info: Remediation blocked by gates
      - alert: ReconcileRemediationBlocked
        expr: increase(grinder_reconcile_action_blocked_total[5m]) > 0
        for: 0m
        labels:
          severity: info
        annotations:
          summary: "Reconcile remediation action blocked"
          description: "Remediation was blocked by safety gates. This is expected behavior during staged rollout."
          runbook_url: "docs/runbooks/16_RECONCILE_ALERTS_SLOS.md#reconcileremediationblocked"

      # Warning: High mismatch rate but no blocks (gates may be bypassed)
      - alert: ReconcileMismatchNoBlocks
        expr: |
          sum(rate(grinder_reconcile_runs_with_mismatch_total[5m])) > 0
          and
          sum(rate(grinder_reconcile_action_blocked_total[5m])) == 0
          and
          sum(rate(grinder_reconcile_action_planned_total[5m])) == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Mismatches detected but no remediation planned or blocked"
          description: "Mismatches are detected but no actions are being planned/blocked. Check RECONCILE_ACTION setting."
          runbook_url: "docs/runbooks/16_RECONCILE_ALERTS_SLOS.md#reconcilemismatchnoblocks"

      # Warning: Budget calls exhausted (no more remediation calls allowed today)
      # Only fires when budget tracking is active (budget_configured=1)
      - alert: ReconcileBudgetCallsExhausted
        expr: |
          grinder_reconcile_budget_configured == 1
          and
          grinder_reconcile_budget_calls_remaining_day == 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Reconcile budget calls exhausted"
          description: "No remediation calls remaining for today. Used: {{ with query \"grinder_reconcile_budget_calls_used_day\" }}{{ . | first | value }}{{ end }} calls."
          runbook_url: "docs/runbooks/16_RECONCILE_ALERTS_SLOS.md#reconcilebudgetcallsexhausted"

      # Warning: Budget notional exhausted or critically low
      # Only fires when budget tracking is active (budget_configured=1)
      - alert: ReconcileBudgetNotionalLow
        expr: |
          grinder_reconcile_budget_configured == 1
          and
          grinder_reconcile_budget_notional_remaining_day < 10
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Reconcile budget notional critically low"
          description: "Notional budget remaining is {{ $value | printf \"%.2f\" }} USDT (threshold: 10). Used today: {{ with query \"grinder_reconcile_budget_notional_used_day\" }}{{ . | first | value | printf \"%.2f\" }}{{ end }} USDT."
          runbook_url: "docs/runbooks/16_RECONCILE_ALERTS_SLOS.md#reconcilebudgetnotionallow"

  # M8-02d: ML Inference Performance SLO Alerts
  - name: grinder_ml_inference
    rules:
      # Warning: ML inference p99 latency exceeds 100ms SLO
      - alert: MlInferenceLatencyHigh
        expr: |
          histogram_quantile(0.99,
            sum(rate(grinder_ml_inference_latency_ms_bucket[5m])) by (le, mode)
          ) > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ML inference p99 latency exceeds SLO"
          description: "ML inference p99 latency is {{ $value | printf \"%.1f\" }}ms (SLO: 100ms). Check ONNX model performance."
          runbook_url: "docs/runbooks/18_ML_INFERENCE_SLOS.md#mlinferencelatencyhigh"

      # Critical: ML inference p99.9 latency exceeds 250ms
      - alert: MlInferenceLatencyCritical
        expr: |
          histogram_quantile(0.999,
            sum(rate(grinder_ml_inference_latency_ms_bucket[5m])) by (le, mode)
          ) > 250
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "ML inference p99.9 latency critically high"
          description: "ML inference p99.9 latency is {{ $value | printf \"%.1f\" }}ms (threshold: 250ms). Consider model optimization or kill-switch."
          runbook_url: "docs/runbooks/18_ML_INFERENCE_SLOS.md#mlinferencelatencycritical"

      # Warning: ML inference error rate exceeds 5%
      - alert: MlInferenceErrorRateHigh
        expr: |
          (
            rate(grinder_ml_inference_errors_total[5m])
            /
            (rate(grinder_ml_inference_total[5m]) + rate(grinder_ml_inference_errors_total[5m]) + 0.001)
          ) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "ML inference error rate exceeds 5%"
          description: "ML inference error rate is {{ $value | printf \"%.1f\" }}%. Check model and input data."
          runbook_url: "docs/runbooks/18_ML_INFERENCE_SLOS.md#mlinferenceerrorratehigh"

      # Info: ML ACTIVE mode is persistently blocked
      - alert: MlActiveModePersistentlyBlocked
        expr: |
          grinder_ml_active_on == 0
          and
          sum(rate(grinder_ml_block_total[5m])) > 0
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "ML ACTIVE mode persistently blocked"
          description: "ML ACTIVE mode has been blocked for 15+ minutes. Check block reasons in metrics."
          runbook_url: "docs/runbooks/18_ML_INFERENCE_SLOS.md#mlactivemodepersistentlyblocked"

      # Warning: No ML inferences in 10 minutes (when ML should be active)
      - alert: MlInferenceStalled
        expr: |
          increase(grinder_ml_inference_total[10m]) == 0
          and
          increase(grinder_ml_inference_errors_total[10m]) == 0
          and
          grinder_up == 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "No ML inferences detected"
          description: "No ML inferences (success or error) in 10 minutes while GRINDER is up. Check ML configuration."
          runbook_url: "docs/runbooks/18_ML_INFERENCE_SLOS.md#mlinferencestalled"

  # Launch-04: Data Quality Alerts
  # Thresholds are conservative — tune after 1 week of shadow/staging.
  # No symbol= labels anywhere (stream= only).
  - name: grinder_data_quality
    rules:
      # Page: Data staleness burst — exchange or ingestion lagging
      - alert: GrinderDataStaleBurst
        expr: rate(grinder_data_stale_total[5m]) > 0.05
        for: 3m
        labels:
          severity: page
        annotations:
          summary: "Data staleness burst detected"
          description: "Staleness events firing at {{ $value | printf \"%.3f\" }}/sec over 5 minutes. Exchange feed or ingestion may be lagging."
          runbook_url: "docs/runbooks/23_DATA_QUALITY_TRIAGE.md#grinderdatastaleburst"

      # Ticket: Tick gaps in large buckets (>1s)
      - alert: GrinderDataGapSpike
        expr: rate(grinder_data_gap_total[5m]) > 0.02
        for: 5m
        labels:
          severity: ticket
        annotations:
          summary: "Tick gap rate elevated"
          description: "Tick gaps firing at {{ $value | printf \"%.3f\" }}/sec. Check exchange connectivity and WebSocket health."
          runbook_url: "docs/runbooks/23_DATA_QUALITY_TRIAGE.md#grinderdatagapspike"

      # Ticket: Price outlier spike
      - alert: GrinderDataOutlierSpike
        expr: rate(grinder_data_outlier_total{kind="price"}[5m]) > 0.02
        for: 5m
        labels:
          severity: ticket
        annotations:
          summary: "Price outlier rate elevated"
          description: "Price outlier events at {{ $value | printf \"%.3f\" }}/sec. May indicate flash crash, exchange glitch, or misconfigured thresholds."
          runbook_url: "docs/runbooks/23_DATA_QUALITY_TRIAGE.md#grinderdataoutlierspike"

      # Page: DQ gate is actively blocking remediation
      - alert: GrinderDQBlockingActive
        expr: |
          rate(grinder_reconcile_action_blocked_total{reason=~"data_quality_(stale|gap|outlier)"}[5m]) > 0
        for: 2m
        labels:
          severity: page
        annotations:
          summary: "DQ gate is blocking remediation actions"
          description: "Remediation blocked by data quality gate (reason={{ $labels.reason }}). Rate: {{ $value | printf \"%.3f\" }}/sec. Investigate data feed quality before taking action."
          runbook_url: "docs/runbooks/23_DATA_QUALITY_TRIAGE.md#grinderdqblockingactive"

  # Launch-05 PR3: HTTP Latency / Retry Alerts
  # Metrics from src/grinder/observability/latency_metrics.py (PR1/PR2).
  # Labels: op= only. No symbol= anywhere.
  # Thresholds are conservative — tune after 1-2 weeks of data.
  - name: grinder_http_latency
    rules:
      # Page: Write-op deadline misses (timeout on cancel/place/cancel_all)
      # These are the most latency-sensitive ops. A burst of timeouts means
      # orders may not be reaching the exchange in time.
      - alert: GrinderHttpWriteDeadlineMissBurst
        expr: |
          sum(rate(grinder_http_fail_total{reason="timeout",op=~"cancel_order|place_order|cancel_all"}[5m])) > 0.02
        for: 2m
        labels:
          severity: page
        annotations:
          summary: "Write-op deadline misses (timeout) elevated"
          description: "Timeout failures on write ops at {{ $value | printf \"%.3f\" }}/sec. Cancel/place orders may not be reaching the exchange. Check network latency and exchange status."
          runbook_url: "docs/runbooks/24_LATENCY_RETRY_TRIAGE.md#grinderhttpwritedeadlinemissburst"

      # Page: cancel_order p99 latency exceeds deadline budget (600ms default)
      # If p99 is above budget, most cancel attempts are timing out.
      - alert: GrinderHttpCancelLatencyP99High
        expr: |
          histogram_quantile(0.99,
            sum(rate(grinder_http_latency_ms_bucket{op="cancel_order"}[5m])) by (le)
          ) > 600
        for: 3m
        labels:
          severity: page
        annotations:
          summary: "cancel_order p99 latency exceeds deadline budget"
          description: "cancel_order p99 latency is {{ $value | printf \"%.0f\" }}ms (budget: 600ms). Most cancel attempts are at risk of timing out. Check exchange API latency."
          runbook_url: "docs/runbooks/24_LATENCY_RETRY_TRIAGE.md#grinderhttpcancellatencyp99high"

      # Ticket: Read-op retries elevated (get_positions, get_account, etc.)
      # Sustained retries waste budget and indicate degraded connectivity.
      - alert: GrinderHttpReadRetriesSpike
        expr: |
          sum(rate(grinder_http_retries_total{op=~"get_positions|get_account|get_open_orders|exchange_info|ping_time"}[5m])) > 0.05
        for: 5m
        labels:
          severity: ticket
        annotations:
          summary: "Read-op HTTP retries elevated"
          description: "Read-op retry rate at {{ $value | printf \"%.3f\" }}/sec over 5 minutes. Sustained retries waste latency budget. Check exchange connectivity."
          runbook_url: "docs/runbooks/24_LATENCY_RETRY_TRIAGE.md#grinderhttpreadretriesspike"

      # Ticket: 429 rate-limit retries spiking
      # Exchange is throttling us. May need to reduce request frequency.
      - alert: GrinderHttp429RateLimitSpike
        expr: |
          sum(rate(grinder_http_retries_total{reason="429"}[5m])) > 0.01
        for: 3m
        labels:
          severity: ticket
        annotations:
          summary: "HTTP 429 rate-limit retries detected"
          description: "Rate-limit retries at {{ $value | printf \"%.3f\" }}/sec. Exchange is throttling requests. Consider reducing reconcile interval or request frequency."
          runbook_url: "docs/runbooks/24_LATENCY_RETRY_TRIAGE.md#grinderhttp429ratelimitspike"

  # Launch-06 PR3: Fill Ingestion Health Alerts
  # Metrics from src/grinder/observability/fill_metrics.py (PR3).
  # Labels: source=, reason=, result= only. No symbol= anywhere.
  - name: grinder_fill_health
    rules:
      # Warning: Fill ingest is disabled (informational status alert)
      - alert: FillIngestDisabled
        expr: |
          max_over_time(grinder_fill_ingest_enabled{source="reconcile"}[5m]) < 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Fill ingest disabled (FILL_INGEST_ENABLED != 1)"
          description: "Fill ingestion is not active. Set FILL_INGEST_ENABLED=1 to enable."
          runbook_url: "docs/runbooks/26_FILL_TRACKER_TRIAGE.md#fillingestdisabled"

      # Page: Fill ingest polls stopped (enabled but not polling)
      - alert: FillIngestNoPolls
        expr: |
          increase(grinder_fill_ingest_polls_total{source="reconcile"}[10m]) == 0
          and
          grinder_fill_ingest_enabled{source="reconcile"} == 1
        for: 10m
        labels:
          severity: page
        annotations:
          summary: "No fill ingest polls for 10m"
          description: "Fill ingestion is enabled but no polls detected in 10 minutes. Reconcile loop may be stuck."
          runbook_url: "docs/runbooks/26_FILL_TRACKER_TRIAGE.md#fillingestnopolls"

      # Page: Cursor save errors (dedup at risk after restart)
      - alert: FillCursorSaveErrors
        expr: |
          increase(grinder_fill_cursor_save_total{source="reconcile",result="error"}[10m]) > 0
        for: 5m
        labels:
          severity: page
        annotations:
          summary: "Fill cursor save failing"
          description: "Cursor persistence is broken. After restart, old trades may be re-ingested. Check disk permissions and path."
          runbook_url: "docs/runbooks/26_FILL_TRACKER_TRIAGE.md#fillcursorsaveerrors"

      # Warning: Parse errors (schema drift or unexpected Binance payload)
      - alert: FillParseErrors
        expr: |
          increase(grinder_fill_ingest_errors_total{source="reconcile",reason="parse"}[10m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Fill parse errors detected"
          description: "Binance userTrades response contains fields the parser cannot handle. Check for API schema changes."
          runbook_url: "docs/runbooks/26_FILL_TRACKER_TRIAGE.md#fillparseerrors"

      # Warning: HTTP errors fetching userTrades (elevated threshold for noise)
      - alert: FillIngestHttpErrors
        expr: |
          increase(grinder_fill_ingest_errors_total{source="reconcile",reason="http"}[10m]) > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Fill ingest HTTP errors rising"
          description: "More than 3 HTTP errors fetching userTrades in 10 minutes. Check Binance connectivity and API key permissions."
          runbook_url: "docs/runbooks/26_FILL_TRACKER_TRIAGE.md#fillingesthttperrors"

      # Warning: Fill cursor not advancing (PR6 — stuck detection)
      # Disambiguated from quiet markets: cursor is saved on every successful
      # poll (PR6), so cursor_age_seconds stays low during quiet markets.
      # Suppressed when cursor_save errors or non-monotonic rejections are
      # present (those have their own alerts).
      - alert: FillCursorStuck
        expr: |
          grinder_fill_cursor_age_seconds{source="reconcile"} > 1800
          and
          grinder_fill_ingest_enabled{source="reconcile"} == 1
          and
          increase(grinder_fill_ingest_polls_total{source="reconcile"}[30m]) > 0
          and
          increase(grinder_fill_cursor_save_total{source="reconcile",result=~"error|rejected_non_monotonic"}[30m]) == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Fill cursor not saved for 30m"
          description: "Fill ingest is enabled and polling, but cursor has not been saved for 30+ minutes. This alert is suppressed when cursor_save errors or non-monotonic rejections are present (those have their own alerts). Check cursor file permissions, disk space, and logs."
          runbook_url: "docs/runbooks/26_FILL_TRACKER_TRIAGE.md#fillcursorstuck"

      # Warning: Cursor writes rejected due to non-monotonic trade_id/ts_ms (PR6)
      - alert: FillCursorNonMonotonicRejected
        expr: |
          increase(grinder_fill_cursor_save_total{source="reconcile",result="rejected_non_monotonic"}[30m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Cursor writes rejected (non-monotonic)"
          description: "Cursor save was rejected because the new (trade_id, ts_ms) tuple is less than the existing file. This may indicate data corruption or a logic bug."
          runbook_url: "docs/runbooks/26_FILL_TRACKER_TRIAGE.md#fillcursornonmonotonicrejected"

  # Launch-13: FSM Orchestrator Alerts
  # Metrics from src/grinder/live/fsm_metrics.py.
  # Labels: state=, intent=, from_state=, to_state=, reason= only.
  # Safe-by-default: metrics emit zero-value baselines when FSM inactive.
  - name: grinder_fsm
    rules:
      # Warning: FSM stuck in bad state (DEGRADED/EMERGENCY/PAUSED) for >2min
      - alert: FsmBadStateTooLong
        expr: |
          (grinder_fsm_current_state{state=~"DEGRADED|EMERGENCY|PAUSED"} == 1)
          and
          (grinder_fsm_state_duration_seconds > 120)
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "FSM stuck in {{ $labels.state }} for >2 minutes"
          description: "FSM has been in {{ $labels.state }} state for {{ $value | printf \"%.0f\" }}s. Check operator override or underlying trigger (kill-switch, feed stale, drawdown)."
          runbook_url: "docs/runbooks/27_FSM_OPERATOR_OVERRIDE.md#fsmbadstatetoolong"

      # Warning: FSM blocking actions (intents rejected by permission matrix)
      - alert: FsmActionBlockedSpike
        expr: |
          sum(increase(grinder_fsm_action_blocked_total[5m])) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "FSM blocking intents"
          description: "FSM permission matrix has blocked {{ $value | printf \"%.0f\" }} intents in 5 minutes. Check current FSM state and whether operator override is needed."
          runbook_url: "docs/runbooks/27_FSM_OPERATOR_OVERRIDE.md#fsmactionblockedspike"

  # Launch-14: Smart Order Router Alerts
  # Metrics from src/grinder/execution/sor_metrics.py.
  # Labels: decision=, reason= only.
  - name: grinder_sor
    rules:
      # Warning: SOR blocking orders (BLOCK decisions)
      - alert: SorBlockedSpike
        expr: |
          sum(increase(grinder_router_decision_total{decision="BLOCK"}[5m])) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "SOR blocking orders"
          description: "SOR has issued {{ $value | printf \"%.0f\" }} BLOCK decisions in 5 minutes. Orders are being rejected by the router."
          runbook_url: "docs/runbooks/28_SOR_FIRE_DRILL.md#sorblockedspike"

      # Info: SOR NOOP decisions (no action needed, but worth monitoring)
      - alert: SorNoopSpike
        expr: |
          sum(increase(grinder_router_decision_total{decision="NOOP"}[5m])) > 0
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "SOR NOOP decisions detected"
          description: "SOR has issued {{ $value | printf \"%.0f\" }} NOOP decisions in 5 minutes. Orders are being skipped (already in desired state)."
          runbook_url: "docs/runbooks/28_SOR_FIRE_DRILL.md#sornoopspike"

  # Launch-15: AccountSync Alerts
  # Metrics from src/grinder/account/metrics.py.
  # Labels: reason=, rule= only.
  # Safe-by-default: AccountSyncStale guarded by last_ts > 0 (inactive = no alert).
  - name: grinder_account_sync
    rules:
      # Warning: Account sync data is stale (enabled but not refreshing)
      # Guard: last_ts > 0 ensures alert only fires when sync has been active.
      - alert: AccountSyncStale
        expr: |
          grinder_account_sync_last_ts > 0
          and
          grinder_account_sync_age_seconds > 120
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Account sync stale (age {{ $value | printf \"%.0f\" }}s)"
          description: "Account sync data is {{ $value | printf \"%.0f\" }}s old (threshold: 120s). Positions and open orders may be outdated."
          runbook_url: "docs/runbooks/29_ACCOUNT_SYNC.md#accountsyncstale"

      # Warning: Account sync errors (HTTP, auth, parse failures)
      - alert: AccountSyncErrors
        expr: |
          sum(increase(grinder_account_sync_errors_total{reason!="none"}[5m])) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Account sync errors detected"
          description: "{{ $value | printf \"%.0f\" }} account sync errors in 5 minutes. Check API connectivity and credentials."
          runbook_url: "docs/runbooks/29_ACCOUNT_SYNC.md#accountsyncerrors"

      # Warning: Account sync mismatches (position/order discrepancies)
      - alert: AccountSyncMismatchSpike
        expr: |
          sum(increase(grinder_account_sync_mismatches_total{rule!="none"}[5m])) > 0
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Account sync mismatches detected"
          description: "{{ $value | printf \"%.0f\" }} account sync mismatches in 5 minutes. Expected vs observed state diverged."
          runbook_url: "docs/runbooks/30_ACCOUNT_SYNC_FIRE_DRILL.md#accountsyncmismatchspike"

  # PR-C8: Fill Probability Circuit Breaker
  # Metric from src/grinder/execution/sor_metrics.py.
  # No labels (counter, label-free).
  - name: grinder_fill_prob_cb
    rules:
      # Warning: Circuit breaker tripped (block rate exceeded threshold)
      - alert: FillProbCircuitBreakerTripped
        expr: |
          increase(grinder_router_fill_prob_cb_trips_total[5m]) > 0
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "Fill probability circuit breaker tripped"
          description: "Fill probability gate block rate exceeded threshold. Circuit breaker bypassed the gate to prevent over-blocking. Review model calibration and threshold."
          runbook_url: "docs/runbooks/31_FILL_PROB_ROLLOUT.md#circuit-breaker-tuning"

      # Warning: Fill probability gate blocking orders (early warning before CB trips)
      - alert: FillProbBlocksSpike
        expr: increase(grinder_router_fill_prob_blocks_total[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Fill probability gate blocking orders"
          description: "{{ $value | printf \"%.0f\" }} fill-prob blocks in 5 minutes. Model may be rejecting orders. Check threshold calibration."
          runbook_url: "docs/runbooks/31_FILL_PROB_ROLLOUT.md#circuit-breaker-tuning"

      # Critical: Fill probability gate blocking heavily (escalation from FillProbBlocksSpike)
      - alert: FillProbBlocksHigh
        expr: increase(grinder_router_fill_prob_blocks_total[5m]) >= 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Fill probability gate blocking heavily"
          description: "{{ $value | printf \"%.0f\" }} fill-prob blocks in 5 minutes (>=10). Model is cutting order flow significantly. Immediate review needed."
          runbook_url: "docs/runbooks/31_FILL_PROB_ROLLOUT.md#circuit-breaker-tuning"
